<html>

<head>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">

</head>

<body>
    <!--<table class="table table-sm">
        <thead>
            <tr>
                <th>Ask</th>
                <th>Bid</th>
                <th>Close</th>
                <th>Volume</th>
                <th>Volume weighted average price</th>
                <th>Number of trades</th>
                <th>Low price</th>
                <th>High price</th>
                <th>Open price</th>
            </tr>
        </thead>
        <tbody id="databody">

        </tbody>
    </table>-->
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Price</th>
                <th>Volume</th>
                <th>Side</th>
            </tr>
        </thead>
        <tbody id="databody">

        </tbody>
    </table>
    <div id="container">
        <canvas id="myChart" width="400" height="100"></canvas>
    </div>


    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"
        integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script type="text/javascript">
        'use strict';
        var krakenDataset = []; //initDataset();
        var latestDeals = [];

        initDataset();
        function callback(jsonResponse) {
            let krakenResult = JSON.parse(jsonResponse);
            console.log(krakenResult)
            for (const result of krakenResult["result"]["XXBTZUSD"]) {
                //console.log(krakenResult["result"]["XXBTZUSD"][0]);

                if (!isNaN(result[2])) {//console.log(Math.trunc(result[2] * 1000));
                    krakenDataset.push({
                        x: new Date(Math.trunc(result[2] * 1000)).toISOString(),
                        y: result[0]
                    });
                }
            }
            myChart.update();
        }
        function initDataset() {
            let targetUrl = "/trades?pair=XBTUSD";
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                    callback(xmlHttp.responseText);
            }
            xmlHttp.open("GET", targetUrl, true); // true for asynchronous 
            xmlHttp.send(null);
        }

        var dataBodyElement = document.querySelector("#databody");

        function subscribe() {
            let socket = new WebSocket("wss://ws.kraken.com");
            let message = {
                "event": "subscribe",
                "pair": [
                    "XBT/USD",
                    //"XBT/EUR"
                ],
                "subscription": {
                    "name": "trade"
                    //"name": "ticker"
                }
            }

            socket.onopen = function (e) {
                console.log("[open] Connection established");
                console.log("Sending to server");
                socket.send(JSON.stringify(message));
            };

            socket.onmessage = function (event) {
                console.log(`[message] Data received from server: ${event.data}`);
                var data = JSON.parse(event.data);
                if (data[1]) {
                    console.log(data[1][0][2]);
                    krakenDataset.push({
                        //x: new Date(Date.now()).toISOString(),
                        x: new Date(Math.trunc(data[1][0][2] * 1000)).toISOString(),
                        y: data[1][0][0]
                    })
                    myChart.update();
                    
                    dataBodyElement.insertAdjacentHTML("afterbegin",
                        `<tr>
                            <td>${data[1][0][0]}</td>
                            <td>${new Date(Math.trunc(data[1][0][2] * 1000)).toISOString()}</td>
                            <td>${data[1][0][3]}</td>
                        </tr>`
                    )
                    if (dataBodyElement.childNodes.length > 10) {
                        dataBodyElement.remove(dataBodyElement.lastChild);
                    }
                }
                //for items in 
                //document.querySelector("#dataBody")
            };

            socket.onclose = function (event) {
                if (event.wasClean) {
                    console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                } else {
                    // e.g. server process killed or network down
                    // event.code is usually 1006 in this case
                    console.log('[close] Connection died');
                }
            };

            socket.onerror = function (error) {
                console.log(`[error] ${error.message}`);
            };
        }


        // Any of the following formats may be used
        const ctx = document.querySelector('#myChart');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label:"Latest Prices",
                    data: krakenDataset,
                    pointRadius: 1,
                    pointHoverRadius: 1

                }]
            },
            options: {
                scales: {
                    x: {
                        // The axis for this scale is determined from the first letter of the id as `'x'`
                        // It is recommended to specify `position` and / or `axis` explicitly.
                        //type: 'time',
                        //min: '2021-11-07 00:00:00'
                        type: "time",
                        distribution: 'linear',
                        time: {
                            displayFormats: {
                                millisecond: 'hh:mm:ss.SSS',
                                second: 'hh:mm:ss',
                                minute: "hh:mm",
                                hour: "hh"
                            }
                        }

                    }
                }
            }
        });

        subscribe()

    </script>
    <!--
    options: {
    scales: {
      myScale: {
        type: 'logarithmic',
        position: 'right', // `axis` is determined by the position as `'y'`
      }
    }
  }

-->
</body>

</html>